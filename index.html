

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Action Runner</title>
<style>
:root { --primary-white: #FFFFFF; --off-white-light: #F8F9FA; --off-white-medium: #E9ECEF; --accent-color: #007bff; --custom-green-color: #28a745; --custom-red-color: #dc3545; --border-radius: 15px; --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); --text-color-dark: #343A40; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(to right, #f3e0ff, #e0f7ff); color: var(--text-color-dark); line-height: 1.6; padding: 15px; }
main { max-width: 900px; margin: 0 auto; }
.container { background-color: var(--primary-white); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; margin-top: 10px; }
h2 { margin-bottom: 20px; font-size: 2em; color: var(--accent-color); text-align: center; }
.btn-styled { display: flex; align-items: center; justify-content: center; width: 100%; max-width: 400px; margin: 10px auto; padding: 12px 15px; color: white; border: none; border-radius: var(--border-radius); box-shadow: 0 10px 20px rgba(0, 123, 255, 0.25); font-weight: 500; font-size: 1.05em; text-align: center; cursor: pointer; transition: all 0.25s ease-out; }
.btn-styled:hover { transform: translateY(-3px); }
.btn-styled:disabled { cursor: not-allowed; opacity: 0.6; }
.action-runner { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
#workflow-checkbox-container { border: 1px solid var(--off-white-medium); border-radius: var(--border-radius); padding: 12px; background-color: var(--off-white-light); }
.workflow-checkbox-item { display: flex; align-items: center; margin-bottom: 10px; }
.workflow-checkbox-item label { margin-left: 8px; cursor: pointer; flex-grow: 1; }
input[type="checkbox"] { transform: scale(1.3); margin-right: 10px; }
.workflow-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
.workflow-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--off-white-medium); border-radius: var(--border-radius); }
.workflow-item-info { display: flex; flex-direction: column; flex-grow: 1; margin-left: 10px; }
.section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--off-white-medium); padding-bottom: 10px; margin-bottom: 10px; }
.tab-separator { border: none; height: 1px; background-color: var(--off-white-medium); margin: 20px 0; }
</style>
</head>
<body>
<main>
<div class="container">
    <h2>Bảng Điều Khiển</h2>
    <div class="action-runner">
        <div id="workflow-checkbox-container"><p>Đang tải danh sách workflows...</p></div>
        <button class="btn-styled" id="toggle-loop-btn" disabled style="background-color: var(--custom-green-color);">Chạy Lặp Lại</button>
        <button class="btn-styled" id="reload-lists-btn" style="background-color: var(--accent-color);">Tải Lại Danh Sách</button>
    </div>
    <hr class="tab-separator">
    <div class="section-header"><h4>Đang chạy</h4></div>
    <div id="running-workflows" class="workflow-list"><p>Đang tải...</p></div>
    <hr class="tab-separator">
    <div class="section-header"><h4>Đã dừng</h4></div>
    <div id="completed-workflows" class="workflow-list"><p>Đang tải...</p></div>
</div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const OWNER = 'Thuongquanggg';
    const REPO = 'Test'; // Thay bằng repo của bạn nếu khác
    const API_URL = `https://api.github.com/repos/${OWNER}/${REPO}`;

    // Token này chỉ dùng để đọc, nếu repo là public thì có thể để trống
    const FRONTEND_TOKEN = ''; 

    const toggleLoopBtn = document.getElementById('toggle-loop-btn');
    const workflowCheckboxContainer = document.getElementById('workflow-checkbox-container');
    const runningWorkflowsDiv = document.getElementById('running-workflows');
    const completedWorkflowsDiv = document.getElementById('completed-workflows');
    const reloadListsBtn = document.getElementById('reload-lists-btn');

    let isLoopingOnServer = false;
    let loopingWorkflowId = null;

    // Hàm gửi lệnh đến server Netlify
    async function callLoopHandler(payload) {
        try {
            // Đường dẫn /.netlify/functions/tên-file-js là mặc định của Netlify
            const response = await fetch('/.netlify/functions/loop-handler', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Lỗi không xác định từ server.');
            }
            return await response.json();
        } catch (error) {
            console.error("Lỗi khi gọi Netlify Function:", error);
            alert(`Lỗi giao tiếp với server: ${error.message}`);
            throw error;
        }
    }

    // Cập nhật giao diện dựa trên trạng thái của server
    function updateUIForLoopState(isRunning, wfId) {
        isLoopingOnServer = isRunning;
        loopingWorkflowId = wfId;
        if (isRunning) {
            toggleLoopBtn.textContent = 'Dừng Lặp Lại';
            toggleLoopBtn.style.backgroundColor = 'var(--custom-red-color)';
            document.querySelectorAll('#workflow-checkbox-container input[type="checkbox"]').forEach(cb => {
                cb.disabled = true;
                cb.checked = (cb.dataset.workflowId === wfId);
            });
            reloadListsBtn.disabled = true;
        } else {
            toggleLoopBtn.textContent = 'Chạy Lặp Lại';
            toggleLoopBtn.style.backgroundColor = 'var(--custom-green-color)';
            document.querySelectorAll('#workflow-checkbox-container input[type="checkbox"]').forEach(cb => {
                cb.disabled = false;
                cb.checked = false;
            });
            reloadListsBtn.disabled = false;
        }
    }

    // Hàm xử lý khi nhấn nút Chạy/Dừng
    async function toggleWorkflowLoop() {
        toggleLoopBtn.disabled = true;
        if (isLoopingOnServer) {
            // Gửi lệnh DỪNG
            try {
                const result = await callLoopHandler({ action: 'stop' });
                alert(result.message);
                updateUIForLoopState(false, null);
            } catch (e) { /* Lỗi đã được alert */ }
        } else {
            // Gửi lệnh BẮT ĐẦU
            const selected = workflowCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
            if (selected.length !== 1) {
                alert('Vui lòng chọn ĐÚNG MỘT workflow để chạy lặp lại.');
                toggleLoopBtn.disabled = false;
                return;
            }
            const workflowId = selected[0].dataset.workflowId;
            try {
                const result = await callLoopHandler({ action: 'start', workflowId: workflowId });
                alert(result.message);
                updateUIForLoopState(true, workflowId);
            } catch (e) { /* Lỗi đã được alert */ }
        }
        toggleLoopBtn.disabled = false;
        loadAllLists();
    }

    // Hàm gọi API GitHub chỉ để đọc thông tin (không cần token nếu repo public)
    async function githubApi(endpoint) {
        const fetchOptions = {};
        if (FRONTEND_TOKEN) {
            fetchOptions.headers = { 'Authorization': `token ${FRONTEND_TOKEN}` };
        }
        const response = await fetch(`${API_URL}${endpoint}`, fetchOptions);
        if (!response.ok) throw new Error(`Lỗi API GitHub (${response.status})`);
        return response.json();
    }

    // Các hàm hiển thị danh sách (giữ nguyên)
    async function loadWorkflows() {
        workflowCheckboxContainer.innerHTML = '<p>Đang tải...</p>';
        try {
            const data = await githubApi('/actions/workflows');
            workflowCheckboxContainer.innerHTML = '';
            data.workflows.filter(wf => wf.state === 'active').forEach(workflow => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'workflow-checkbox-item';
                itemDiv.innerHTML = `<input type="checkbox" id="wf-${workflow.id}" data-workflow-id="${workflow.id}"><label for="wf-${workflow.id}">${workflow.name}</label>`;
                workflowCheckboxContainer.appendChild(itemDiv);
            });
            toggleLoopBtn.disabled = false;
        } catch (e) {
            workflowCheckboxContainer.innerHTML = `<p>Lỗi tải workflows: ${e.message}</p>`;
        }
    }

    function renderRuns(runs, container) {
        if (!runs || runs.length === 0) {
            container.innerHTML = `<p style="text-align: center;">Không có mục nào.</p>`;
            return;
        }
        container.innerHTML = '';
        runs.forEach(run => {
            const item = document.createElement('div');
            item.className = 'workflow-item';
            item.innerHTML = `<div class="workflow-item-info"><strong>${run.name} (#${run.run_number})</strong><div>Trạng thái: ${run.status}</div></div>`;
            container.appendChild(item);
        });
    }

    async function loadWorkflowRuns() {
        runningWorkflowsDiv.innerHTML = '<p>Đang tải...</p>';
        completedWorkflowsDiv.innerHTML = '<p>Đang tải...</p>';
        try {
            const data = await githubApi('/actions/runs?per_page=30');
            const allRuns = data.workflow_runs || [];
            const running = allRuns.filter(r => ['in_progress', 'queued', 'requested', 'waiting'].includes(r.status));
            const completed = allRuns.filter(r => !running.includes(r));
            renderRuns(running, runningWorkflowsDiv);
            renderRuns(completed.slice(0, 10), completedWorkflowsDiv);
        } catch (e) {
            runningWorkflowsDiv.innerHTML = `<p>Lỗi tải runs: ${e.message}</p>`;
        }
    }

    // Khi tải trang, hỏi server xem có vòng lặp nào đang chạy không
    async function checkServerStatusOnLoad() {
        try {
            const status = await callLoopHandler({ action: 'status' });
            updateUIForLoopState(status.isRunning, status.workflowId);
        } catch (e) { console.error("Không thể kiểm tra trạng thái server."); }
    }
    
    async function loadAllLists() {
        await Promise.all([loadWorkflows(), loadWorkflowRuns()]);
        await checkServerStatusOnLoad();
    }

    toggleLoopBtn.addEventListener('click', toggleWorkflowLoop);
    reloadListsBtn.addEventListener('click', loadAllLists);
    loadAllLists();
});
</script>
</body>
</html>